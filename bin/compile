#!/usr/bin/env php
<?php

/*
 * This file is part of Felpado.
 *
 * (c) Pablo Díez <pablodip@gmail.com>
 *
 * This source file is subject to the MIT license that is bundled
 * with this source code in the file LICENSE.
 */

namespace felpado\compile;

require_once __DIR__.'/../src/felpado.php';
\felpado\require_functions();

compile();

function compile() {
    compile_functions();
    compile_doc();
}

function compile_functions() {
    file_put_contents(functions_file_name(), functions_file_contents());
}

function functions_file_name() {
    return __DIR__.'/../felpado-compiled.php';
}

function functions_file_contents() {
    return '<?php'.PHP_EOL
          .PHP_EOL
          .functions_file_header()
          .PHP_EOL
          .implode(PHP_EOL, map(fkey('code'), \felpado\functions()));
}

function functions_file_header() {
    return <<<EOF
/*
 * This file is part of Felpado.
 *
 * (c) Pablo Díez <pablodip@gmail.com>
 *
 * This source file is subject to the MIT license that is bundled
 * with this source code in the file LICENSE.
 */
EOF;
}

function compile_doc() {
    file_put_contents(doc_file_name(), doc_file_contents());
}

function doc_file_name() {
    return __DIR__.'/../FUNCTIONS.md';
}

function doc_file_contents() {
    return doc_file_header()
          ."\n\n"
          .doc_file_function_list()
          ."\n\n"
          .implode("\n\n", map('felpado\compile\function_doc', \felpado\functions()));
}

function doc_file_header() {
    return <<<EOF
# Functions
EOF;
}

function doc_file_function_list() {
    return implode(", ", map(function ($function) {
        return sprintf('[%s](#%s)', $function['name'], $function['name']);
    }, \felpado\functions()));
}

function function_doc($function) {
    return sprintf(<<<EOF
<a name="%s"></a>
### %s

%s

%s

```
%s
```
EOF
        ,
        $function['name'],
        $function['name'],
        preg_replace('/^.*$/m', '`$0`', $function['doc']['usage']),
        $function['doc']['desc'],
        $function['doc']['example']
    );
}